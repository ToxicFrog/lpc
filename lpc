#!/usr/bin/env luajit

BASEDIR = arg[0]:gsub("[^/]+$", '')
if not BASEDIR:match('^/') then
  BASEDIR = './' .. BASEDIR
end
package.path = package.path
  ..";"..BASEDIR.."/lib/?.lua"
  ..";"..BASEDIR.."/lib/?/init.lua"

require "util.flags"
require "util.logging"
require "util.string"
require "util.io"

flags.register ("out", "o") {
  help = "The file to write the output to.";
  type = flags.string;
}

lp = {}

require "macros"
require "packages"

flags.parse(...)

FILE = assert(flags.parsed[1])
for _,package in ipairs(flags.parsed.package) do
  lp.use(package)
end
io.writefile(flags.parsed.out, lp.expand(io.readfile(FILE)))
